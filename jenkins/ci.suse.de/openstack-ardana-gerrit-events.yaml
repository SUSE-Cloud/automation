- job:
    name: 'openstack-ardana-gerrit-events'
    concurrent: false
    triggers:
      - gerrit:
          server-name: 'gerrit.suse.provo.cloud'
          trigger-on:
            - change-merged-event
            - patchset-created-event:
                exclude-drafts: true
                exclude-no-code-change: false
            - comment-added-contains-event:
                comment-contains-value: 'Code-Review|Workflow|Verified|QE-Review'
            - comment-added-contains-event:
                comment-contains-value: '^reverify$'
          silent: true
          projects:
            - project-compare-type: 'REG_EXP'
              project-pattern: !include-raw: gerrit-project-regexp.txt
              branches:
                - branch-pattern: master
                - branch-pattern: stable/pike
    wrappers:
      - workspace-cleanup

    logrotate:
      numToKeep: -1
      daysToKeep: 30

    node: cloud-pipeline

    parameters:
      - string:
          name: GERRIT_CHANGE_NUMBER
          description: |
            Gerrit change number.
            Example: 1234

      - string:
          name: git_automation_repo
          default: https://github.com/SUSE-Cloud/automation.git
          description: >-
            The git automation repository to use

      - string:
          name: git_automation_branch
          default: master
          description: >-
            The git automation branch

    builders:
      - shell: |
          set -x

          IFS='/' read -r -a repo_arr <<< "$git_automation_repo"
          export git_automation_repo="${repo_arr[3]}"
          curl https://raw.githubusercontent.com/$git_automation_repo/automation/$git_automation_branch/scripts/jenkins/ardana/openstack-ardana.prep.sh | bash

          if [[ -n $GERRIT_EVENT_TYPE ]]; then
              if [[ $GERRIT_EVENT_TYPE == 'change-merged' ]]; then
                  automation-git/scripts/jenkins/ardana/gerrit/gerrit_handle_event.py ${GERRIT_CHANGE_NUMBER} merged
              elif [[ $GERRIT_EVENT_TYPE == 'patchset-created' ]]; then
                  automation-git/scripts/jenkins/ardana/gerrit/gerrit_handle_event.py ${GERRIT_CHANGE_NUMBER} updated
              elif [[ $GERRIT_EVENT_TYPE == 'comment-added' ]]; then
                  automation-git/scripts/jenkins/ardana/gerrit/gerrit_merge.py ${GERRIT_CHANGE_NUMBER}
              fi
          else
              automation-git/scripts/jenkins/ardana/gerrit/gerrit_merge.py ${GERRIT_CHANGE_NUMBER}
          fi
