- job-template:
    name: '{openstack_ardana_gerrit_events_job}'
    concurrent: false
    triggers:
      - gerrit:
          server-name: 'gerrit.suse.provo.cloud'
          trigger-on:
            - change-merged-event
            - patchset-created-event:
                exclude-drafts: true
                exclude-no-code-change: false
            - comment-added-contains-event:
                comment-contains-value: 'Code-Review|Workflow|Verified|QE-Review'
            - comment-added-contains-event:
                comment-contains-value: '^reverify$'
          silent: true
          projects:
            - project-compare-type: 'REG_EXP'
              project-pattern: ardana/.*
              branches:
                - branch-pattern: {branch|master}
    wrappers:
      - workspace-cleanup

    logrotate:
      numToKeep: -1
      daysToKeep: 30

    node: cloud-ardana-ci-trigger

    parameters:
      - string:
          name: GERRIT_CHANGE_NUMBER
          description: |
            Gerrit change number.
            Example: 1234

      - string:
          name: git_automation_repo
          default: '{git_automation_repo|https://github.com/SUSE-Cloud/automation.git}'
          description: >-
            The git automation repository to use

      - string:
          name: git_automation_branch
          default: '{git_automation_branch|master}'
          description: >-
            The git automation branch

    builders:
      - shell: |
          set -x

          git clone $git_automation_repo --branch $git_automation_branch automation-git

          if [[ -n $GERRIT_EVENT_TYPE ]]; then
              if [[ $GERRIT_EVENT_TYPE == 'change-merged' ]]; then
                  automation-git/scripts/jenkins/ardana/gerrit/gerrit_handle_event.py ${{GERRIT_CHANGE_NUMBER}} merged
              elif [[ $GERRIT_EVENT_TYPE == 'patchset-created' ]]; then
                  output=$(automation-git/scripts/jenkins/ardana/gerrit/gerrit_handle_event.py ${{GERRIT_CHANGE_NUMBER}} updated)
                  echo "$output" | grep "recheck" | while read -r line ; do
                    parts=($line)
                    automation-git/scripts/jenkins/jenkins-job-trigger "{gatingjob}" gerrit_change_ids="${{parts[1]}}"" cloudsource="{cloudsource}"
                  done
              elif [[ $GERRIT_EVENT_TYPE == 'comment-added' ]]; then
                  automation-git/scripts/jenkins/ardana/gerrit/gerrit_merge.py ${{GERRIT_CHANGE_NUMBER}}
              fi
          else
              automation-git/scripts/jenkins/ardana/gerrit/gerrit_merge.py ${{GERRIT_CHANGE_NUMBER}}
          fi
