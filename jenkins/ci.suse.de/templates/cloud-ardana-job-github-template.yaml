- job-template:
    name: '{ardana_github_job}'
    project-type: pipeline
    concurrent: true
    node: cloud-trigger
    disabled: '{obj:disabled|False}'

    logrotate:
      numToKeep: -1
      daysToKeep: 14

    triggers: '{triggers}'

    parameters:

      - validating-string:
          name: ardana_env
          default: '{ardana_env|}'
          regex: '[A-Za-z0-9-_]+'
          msg: >-
            Empty or malformed value (only alphanumeric, '-' and '_' characters are allowed).
          description: >-
            The virtual or hardware environment identifier. This field should either
            be set to one of the values associated with the known hardware environments
            (e.g. qe101), or to a value that will identify the created virtual environment.

            WARNING: if a virtual environment associated with the supplied ardana_env already
            exists, it will be replaced.

      - bool:
          name: reserve_env
          default: '{reserve_env|true}'
          description: >-
            Reserve the 'ardana_env' lockable resource throughout the execution of this job

      - validating-string:
          name: github_pr_id
          default: ''
          regex: '([0-9]+)'
          msg: The entered value failed validation
          description: >-
            The automation repository pull request number to test (the latest available version
            is assumed).

            For jobs triggered by Gerrit, the Gerrit change number and patchset number are
            extracted from the GERRIT_CHANGE_NUMBER and GERRIT_PATCHSET_NUMBER environment
            variables set by the trigger, which override this parameter.

      - validating-string:
          name: github_context
          default: ''
          regex: '[A-Za-z0-9-_/]+'
          msg: >-
            Empty or malformed value (only alphanumeric, '-', '_' and '/' characters are allowed).
          description: >-
            Unique job identifier, used when reporting progress and results to Github.

            Only one job with a given context value is allowed to run for a GitHub pull request
            at any given time. The job that is triggered latest automatically cancels those that
            are already running for the same context value.
            The context value also determines if the job is required to succeed before the pull
            request can be merged.

      - string:
          name: integration_test_job
          default: '{integration_test_job}'
          description: >-
            The Ardana Jenkins integration job triggered to validate the Github pull-request.
            Leave empty to skip integration testing.

            NOTE: there can be at most one non-voting Gerrit job running the same
            integration test job for a Gerrit change number. The most recent job
            will automatically abort those that are already running for the same
            Gerrit change number and integration test job.

      - validating-string:
          name: gerrit_change_ids
          default: ''
          regex: '(([0-9]+(/[0-9]+)?)(,[0-9]+(/[0-9]+)?)*)*'
          msg: The entered value failed validation
          description: >-
            A comma separated list of IDs for Gerrit changes in
            gerrit.suse.provo.cloud to test. The patchset may be supplied as part
            of each change ID in the form:

               <change_number>[/<patchset_number>]

      - validating-string:
          name: extra_repos
          default: ''
          regex: '((http(s)?:\/\/[^ ,]+\.repo)(,http(s)?:\/\/[^ ,]+\.repo)*)*'
          msg: The entered value failed validation
          description: >-
            A comma separated list of repository urls (ending with .repo) to be
            added on the deployer node

      - hidden:
          name: git_automation_repo
          default: 'https://github.com/SUSE-Cloud/automation.git'
          description: >-
            The git automation repository to use

      - hidden:
          name: git_automation_branch
          default: 'pr/${{github_pr_id}}'
          description: >-
            The git automation branch

      - text:
          name: extra_params
          default:
          description: >-
            This field may be used to define additional parameters, one per line, in the form:

              <parameter_name>=<parameter-value>

            These parameters will be injected into the Jenkins job as environment variables that supplement
            or override the other parameters configured for the Jenkins job.
            This should not be used by default or regularly. It is meant to run job build customized in ways
            not already supported by the job's parameters, such as testing automation git pull requests
            with special configurations.


    pipeline-scm:
      scm:
        - git:
            url: ${{git_automation_repo}}
            branches:
              - ${{git_automation_branch}}
            browser: auto
            wipe-workspace: false
            refspec: "+refs/heads/*:refs/remotes/origin/* +refs/pull/*/head:refs/remotes/origin/pr/*"
      script-path: jenkins/ci.suse.de/pipelines/openstack-ardana-github.Jenkinsfile
      lightweight-checkout: false
