---

- name: Deploy CaaSP using heat templates
  hosts: "{{ ardana_env }}"
  gather_facts: False
  remote_user: ardana
  vars:
    caasp_image_url: "http://provo-clouddata.cloud.suse.de/images/openstack/x86_64/SUSE-CaaS-Platform-3.0-for-OpenStack-Cloud.x86_64-3.0.0-GM.qcow2"
    caasp_image_path: "/tmp/SUSE-CaaS-Platform-3.0-for-OpenStack-Cloud.x86_64-3.0.0-GM.qcow2"
    image_name: "SUSE-CaaS-Platform-3.0-for-OpenStack-Cloud"
  tasks:
  - name: Install caasp-openstack-heat-templates
    check_mode: no
    become: yes
    zypper:
      name: caasp-openstack-heat-templates
      state: present

  - name: Download CaaSP image
    check_mode: no
    get_url:
      url: "{{ caasp_image_url }}"
      dest: "{{ caasp_image_path }}"
      mode: 0600
    register: _download_caasp_image
    until: _download_caasp_image | success
    retries: 5
    delay: 2

  - name: Upload CaaSP image to glance
    check_mode: no
    shell: |
      source ~ardana/service.osrc
      if ! openstack image list | grep "{{ image_name }}"; then openstack image create --public --disk-format qcow2 --container-format bare --file "{{ caasp_image_path }}" "{{ image_name }}"; fi
    args:
      executable: /bin/bash

  - name: Set caasp heat stack common parameters
    set_fact:
      timeout: "120"
      admin_flavor: "m1.medium"
      master_flavor: "m1.medium"
      worker_flavor: "m1.medium"
      worker_count: "1"
      root_password: "linux"
      external_net: "ext-net"
      internal_net_cidr: "172.28.0.0/24"
      dns_nameserver: "172.28.0.2"

  - name: Set caasp heat stack single master parameters
    set_fact:
      stack_name: "caasp-stack"
      stack_template: "caasp-stack.yaml"
      stack_name: "caasp-stack"
      master_count_parameter: ""
    when:
      - deploy_caasp == 'single-master'

  - name: Set caasp heat stack multiple master parameters
    set_fact:
      stack_name: "caasp-multi-master-stack"
      stack_template: "caasp-multi-master-stack.yaml"
      master_count_parameter: "--parameter master_count=2"
    when:
      - deploy_caasp == 'multiple-masters'

  - name: Create caasp heat stack
    check_mode: no
    shell: |
      source ~ardana/service.osrc
      openstack stack create --wait --timeout {{ timeout }} \
      -t {{ stack_template }} \
      --parameter image="{{ image_name }}" \
      --parameter admin_flavor={{ admin_flavor }} \
      --parameter master_flavor={{ master_flavor }} \
      --parameter worker_flavor={{ worker_flavor }} \
      --parameter worker_count={{ worker_count }} \
      --parameter root_password={{ root_password }} \
      --parameter external_net={{ external_net }} \
      --parameter internal_net_cidr={{ internal_net_cidr }} \
      --parameter dns_nameserver={{ dns_nameserver }} \
      {{ master_count_parameter}} \
      "{{ stack_name }}"
      openstack stack show "{{ stack_name }}"
      status=$(openstack stack show "{{ stack_name }}" | grep -w stack_status | awk '{print $4}')
      if [ $status = 'CREATE_COMPLETE' ]; then echo "CaaSP stack created successfully."; else echo "Failed to create stack: $status"; exit 1; fi
    args:
      executable: /bin/bash
      chdir: /usr/share/caasp-openstack-heat-templates/

  - name: Delete downloaded image
    check_mode: no
    file:
      state: absent
      path: "{{ caasp_image_path }}"
