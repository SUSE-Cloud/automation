#!/bin/bash

# Wrapper script to execute cinder-tests-all
# within the venv
#
# Usage: nova-attach-and-move.py PLUS too many options to list

backend="lvm"

test_name="nova-attach"
work_dir={{ ardana_qe_test_work_dir }}
test_dir={{ ardana_qe_tests_dir }}/ardana-qa-tests/cinder-new
test_log="$work_dir/${test_name}.log"
subunit_log="$work_dir/${test_name}.subunit:mjsvenv"

# we do appends to test_log, so start clean
rm $test_log

# messy, if this is run before cider, we need to run cinder-tests-all init to
# set up network AND do it the same way cinder.sh does.
cd $test_dir
source $HOME/keystone.osrc
openstack role add --user admin --project admin cinder_admin
$test_dir/cinder-tests-all $backend init | tee $test_log
source $HOME/service.osrc

# get list of all images we want to test with
i=0
declare -a ids
declare -a names

IFS=$'\n'
for image in $(openstack image list | grep active); do
    if [[ ! $image =~ "cirros" ]] && [[ ! $image =~ "magnum" ]] && [[ ! $image =~ "manila" ]]; then continue; fi

    id=`echo $image | cut -d' ' -f2`
    name=`echo $image | cut -d' ' -f4`

    ids[$i]=$id
    names[$i]=$name
    i=$(( $i+1 ))
done

num_images=$(( $i-1 ))
echo "NUM: $num_images" | tee -a $test_log
for i in `seq 0 $num_images`; do
    echo "ID[$i]: ${ids[$i]}' NAME: ${names[$i]}" | tee -a $test_log
done

for i in `seq 0 $num_images`; do
    echo "ID[$i]: ${ids[$i]}' NAME: ${names[$i]}" | tee -a $test_log

    $test_dir/nova-attach-and-move.py --image ${ids[$i]} --sulog $subunit_log | tee -a $test_log
done

